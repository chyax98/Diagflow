# 宝塔面板反向代理配置说明

## 架构说明

```
公网 (80/443)
  ↓
宝塔 Nginx 反向代理
  ↓
Next.js (3000) ← 唯一对外端口
  ├─ /api/copilotkit → 后端 8000 (内网)
  └─ /api/render → 后端 8000 (内网)

后端 (8000) ← 不对外暴露
```

---

## 配置步骤

### 1. 创建网站

1. 登录宝塔面板
2. 点击「网站」→「添加站点」
3. 输入域名（如 `kroki.example.com`）
4. 选择「纯静态」（不需要 PHP）
5. 点击「提交」

### 2. 配置反向代理

1. 点击网站「设置」按钮
2. 选择「反向代理」标签
3. 点击「添加反向代理」

**配置参数**：
```
代理名称：Kroki Agent
目标 URL：http://127.0.0.1:3000
发送域名：$host
```

4. 点击「保存」

### 3. 高级配置（重要！）

点击反向代理右侧的「配置文件」按钮，添加以下配置：

```nginx
# 在 location / 块中添加以下内容：
location / {
    proxy_pass http://127.0.0.1:3000;

    # WebSocket 支持（CopilotKit 需要）
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # 超时设置（AI 生成图表可能耗时较长）
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # 请求体大小限制
    client_max_body_size 10M;

    # 代理头设置
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### 4. 配置 SSL（可选但推荐）

1. 在网站「设置」中选择「SSL」标签
2. 选择「Let's Encrypt」或上传你的证书
3. 点击「申请」或「保存」
4. 开启「强制 HTTPS」

### 5. 启动服务

在服务器上启动 Docker Compose：

```bash
cd /path/to/krokiagent
docker-compose up -d
```

验证服务运行：
```bash
docker-compose ps
# 应该看到 frontend 和 backend 都在运行
# 注意：backend 没有对外端口映射

curl http://localhost:3000/api/health
# 应该返回 {"ok":true}
```

---

## 验证配置

### 1. 访问网站

浏览器打开 `https://你的域名.com`

应该能看到 Kroki Agent 界面。

### 2. 测试 AI 对话

在右侧聊天框输入：「画一个登录流程图」

应该能看到 AI 生成图表。

### 3. 测试手动编辑

在左侧编辑器手动修改代码，右侧预览应该实时更新。

---

## 常见问题

### Q: WebSocket 连接失败

**症状**：AI 对话无响应，控制台报错 `WebSocket connection failed`

**解决**：检查宝塔反向代理配置是否包含 WebSocket 支持：
```nginx
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
```

### Q: 图表渲染超时

**症状**：复杂图表渲染失败，提示超时

**解决**：增加超时时间：
```nginx
proxy_connect_timeout 120s;
proxy_send_timeout 120s;
proxy_read_timeout 120s;
```

### Q: 后端无法访问

**症状**：前端启动正常，但 AI 对话报错 `ECONNREFUSED`

**解决**：
1. 检查 Docker 容器是否都在运行：`docker-compose ps`
2. 检查后端健康状态：`docker-compose exec backend curl http://localhost:8000/health`
3. 检查 Docker 网络：`docker network inspect krokiagent_app-network`

### Q: SSL 证书申请失败

**解决**：
1. 确保域名已解析到服务器 IP
2. 确保 80 端口可访问（Let's Encrypt 验证需要）
3. 关闭其他占用 80 端口的服务

---

## 安全建议

1. **开启防火墙**：只开放 80、443、SSH 端口
2. **定期更新**：及时更新 Docker 镜像和系统软件
3. **备份数据**：定期备份 Docker 数据卷
4. **限制访问**：可在宝塔中配置 IP 白名单（如果是内部工具）

---

## 性能优化

### 1. 启用 Gzip 压缩

在宝塔网站「设置」→「性能优化」中开启 Gzip。

### 2. 启用浏览器缓存

在宝塔反向代理配置中添加：
```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg)$ {
    proxy_pass http://127.0.0.1:3000;
    expires 7d;
    add_header Cache-Control "public, immutable";
}
```

### 3. 配置 CDN

如果有条件，可以在域名前配置 CDN（如 Cloudflare）加速访问。

---

## 监控和日志

### 查看访问日志

```bash
# 宝塔日志位置
tail -f /www/wwwlogs/你的域名.com.log

# Docker 日志
docker-compose logs -f frontend
docker-compose logs -f backend
```

### 监控资源使用

```bash
# 查看容器资源使用
docker stats

# 查看磁盘使用
docker system df
```
