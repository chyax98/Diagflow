[meta]
language = "nomnoml"
description = "简化的手绘风格UML图表语言，支持类图、组件图、流程图等多种UML风格"
docs_url = "https://nomnoml.com/"
version = "1.0.0"

[types.diagram]
description = "Nomnoml通用图表，支持类图、组件图、架构图、流程图等UML风格图表"
use_cases = ["类图", "组件图", "架构图", "流程图", "用例图", "状态图"]

syntax_rules = """
基础语法规则：
- 节点定义: [节点名称] 或 [<分类器> 节点名称]
- 连接语法: [A] 关联类型 [B]
- 分隔符规则: 属性/方法用分号;或换行分隔，不能用逗号
- 类区域分隔: | 符号，顺序为"类名|属性|方法"
- 注释: 行首使用 // 注释，行内不支持注释

关联类型（11种完整列表）：
1. 关联 (Association):
   - 单向: -> 或 -
   - 双向: <-> 或 <-

2. 依赖 (Dependency):
   - 单向: -->
   - 双向: <-->

3. 继承/泛化 (Generalization):
   - -:> (箭头从子类指向父类，UML标准方向)
   - 示例: [Dog]-:>[Animal] 表示Dog继承Animal

4. 实现 (Realization):
   - --:> (接口实现，虚线箭头)
   - 示例: [MySQLImpl]--:>[Repository]

5. 组合 (Composition):
   - +-> 或 +- (强拥有关系，生命周期绑定)
   - 示例: [Engine]+<-[Car] 表示Car拥有Engine

6. 聚合 (Aggregation):
   - o-> 或 o- (弱拥有关系，生命周期独立)
   - 示例: [Wheel]o-[Car]

7. 球窝连接 (Ball and Socket，组件图专用):
   - o<-) 或 ->o 或 -o)
   - 用于表示接口提供和使用

8. 注释连接 (Note):
   - -- (虚线，连接note元素)

9. 隐藏连接 (Hidden):
   - -/- (布局用，不显示线条)

分类器类型（完整列表）：
类图类型:
- <abstract> - 抽象类
- <interface> - 接口
- <instance> - 实例
- <reference> - 引用

包/框架类型:
- <package> - 包
- <frame> - 框架

流程图类型:
- <start> - 开始节点
- <end> - 结束节点
- <state> - 状态
- <choice> - 选择/判断
- <sync> - 同步点
- <input> - 输入

组件图类型:
- <sender> - 发送者
- <receiver> - 接收者
- <transceiver> - 收发器
- <socket> - 套接字
- <lollipop> - 棒棒糖（接口提供）

用例图类型:
- <actor> - 参与者
- <usecase> - 用例

其他类型:
- <note> - 注释
- <database> - 数据库
- <hidden> - 隐藏（布局用）
- <pipe> - 管道
- <table> - 表格

指令系统（必须在文件开头）：
布局指令:
- #direction: down | right - 图表方向
- #gutter: 数字 - 元素间距（默认5）
- #edgeMargin: 数字 - 边缘边距（默认0）
- #gravity: 数字 - 引力系数（默认1）
- #spacing: 数字 - 节点间距（默认40）

样式指令:
- #fill: 颜色 - 填充色（默认#eee8d5）
- #stroke: 颜色 - 线条颜色（默认#33322E）
- #background: transparent | 颜色 - 背景色
- #fillArrows: true | false - 是否填充箭头

文字指令:
- #font: 字体名 - 字体（默认Calibri）
- #fontSize: 数字 - 字号（默认12）
- #leading: 数字 - 行距（默认1.35）

线条指令:
- #lineWidth: 数字 - 线宽（默认3）
- #arrowSize: 数字 - 箭头大小（默认1）
- #bendSize: 数字 - 弯曲度（默认0.3）
- #edges: hard | rounded - 边缘类型

其他指令:
- #padding: 数字 - 内边距（默认8）
- #title: 文本 - 图表标题
- #zoom: 数字 - 缩放比例（默认1）
- #acyclicer: greedy - 非循环算法
- #ranker: network-simplex | tight-tree | longest-path - 排序算法

自定义样式（以 . 开头）：
定义: #.样式名: 属性列表
应用: [<样式名> 节点名]

可用属性:
- fill=颜色 - 填充色
- stroke=颜色 - 边框色
- align=center | left - 对齐方式
- direction=right | down - 方向
- visual=类型 - 可视化类型（actor, class, database, ellipse, end, frame, hidden, input, none, note, package, pipe, receiver, rhomb, roundrect, sender, start, sync, table, transceiver）
- dashed - 虚线修饰符
- bold, center, italic, left, underline - 文字修饰符
- title=修饰符 - 标题样式（如 title=left,italic,bold）
- body=修饰符 - 正文样式（如 body=center）

ID属性（唯一标识）：
语法: [<id:唯一ID> 显示名称]
用途: 允许不同节点显示相同名称但内部标识不同

嵌套结构：
语法: [容器| [子节点1] [子节点2] ]
用途: 表示包含关系，如包含多个类的包

表格语法：
语法: [<table> 表名| 列1 | 值1 || 列2 | 值2 ]
说明: 使用 || 分隔行，| 分隔列

Kroki限制：
- ❌ 不支持 #import 导入外部文件
- ✓ 所有其他指令和分类器完全支持
- 建议节点数 ≤ 50（复杂图可能渲染慢）
- 嵌套层级 ≤ 3

常见错误避免：
1. 分隔符错误:
   ❌ [Class|attr1, attr2|method()]
   ✓ [Class|attr1; attr2|method()]

2. 继承方向错误:
   ❌ [Animal]-:>[Dog]  (错误：父类指向子类)
   ✓ [Dog]-:>[Animal]  (正确：子类指向父类)

3. 指令位置错误:
   ❌ [Node1] -> [Node2]
       #direction: down
   ✓ #direction: down
       [Node1] -> [Node2]

4. 行内注释:
   ❌ [Node] // 这是节点
   ✓ // 这是节点
       [Node]

5. 逗号分隔:
   ❌ [Person|name, age|walk()]
   ✓ [Person|name; age|walk()]

最佳实践：
- 复杂关系优先使用标准UML符号（-:>, --:>, +->）
- 类图中属性和方法分行书写，提高可读性
- 使用自定义样式统一配色方案
- 合理使用嵌套，避免过深层次
- 为复杂图表添加 #title 说明
"""

examples = [
  """// 基础类图：继承和关联关系
#direction: down
#fontSize: 12

[<abstract> Animal|
  name: String;
  age: int|
  eat(): void;
  sleep(): void]

[Dog|
  breed: String|
  bark(): void]

[Cat|
  indoor: boolean|
  meow(): void]

[Owner|
  name: String|
  adopt(animal: Animal): void]

// 继承关系（子类指向父类）
[Dog] -:> [Animal]
[Cat] -:> [Animal]

// 关联关系
[Owner] -> [Animal]""",

  """// 高级特性：自定义样式+多种关系类型
#direction: right
#.important: fill=#ffcccc stroke=#cc0000 bold
#.interface: fill=#d4f1d4 visual=none
#.note: visual=note fill=#ffffcc

[<important> 用户服务|
  userRepo: UserRepository|
  createUser(): User;
  login(): Token]

[<interface> UserRepository|
  |
  save(user): void;
  findById(id): User]

[MySQL数据库实现|
  connection: Connection|
  save(user): void;
  findById(id): User]

[邮件服务|
  sendMail(to, subject, body): void]

[认证模块]

[<note> 备注|组合关系表示
认证模块生命周期
依赖用户服务]

// 实现接口（虚线箭头）
[MySQL数据库实现] --:> [UserRepository]

// 聚合关系（弱拥有）
[用户服务] o-> [UserRepository]

// 依赖关系（虚线）
[用户服务] --> [邮件服务]

// 组合关系（强拥有）
[用户服务] +-> [认证模块]

// 注释连接
[<note> 备注] -- [用户服务]""",

  """// 用例图和流程图类型
#spacing: 60
#direction: down
#fill: #fef8e8
#stroke: #8b7355

// 用例图元素
[<actor> 用户]
[<usecase> 登录系统]
[<usecase> 查看订单]
[<usecase> 修改密码]

// 用例关系
[用户] -> [登录系统]
[用户] -> [查看订单]
[用户] -> [修改密码]

// 系统依赖
[登录系统] --> [认证服务]
[查看订单] --> [订单服务]

// 流程图元素
[<start> 开始]
[<input> 输入凭证]
[<choice> 验证通过?]
[<state> 已登录]
[<sync> 同步会话]
[<end> 结束]

// 流程连接
[<start> 开始] -> [<input> 输入凭证]
[<input> 输入凭证] -> [<choice> 验证通过?]
[<choice> 验证通过?] -> [<state> 已登录]
[<state> 已登录] -> [<sync> 同步会话]
[<sync> 同步会话] -> [<end> 结束]
[<choice> 验证通过?] -> [<end> 结束]""",

  """// 组件图：服务架构
#direction: right
#.service: fill=#e1f5fe stroke=#0277bd
#.database: visual=database fill=#fff3e0 stroke=#e65100
#.queue: visual=pipe fill=#f3e5f5 stroke=#6a1b9a

[<service> API网关|
  port: 8080|
  route(request): Response;
  auth(token): boolean]

[<service> 用户服务|
  port: 8081|
  getUser(id): User;
  createUser(data): User]

[<service> 订单服务|
  port: 8082|
  createOrder(data): Order;
  getOrders(userId): List]

[<database> 用户数据库|
  type: PostgreSQL|
  query(sql): ResultSet]

[<database> 订单数据库|
  type: MySQL|
  query(sql): ResultSet]

[<queue> 消息队列|
  type: RabbitMQ|
  publish(msg): void;
  subscribe(topic): void]

// 组件关系
[API网关] -> [用户服务]
[API网关] -> [订单服务]
[用户服务] -> [<database> 用户数据库]
[订单服务] -> [<database> 订单数据库]
[订单服务] -> [<queue> 消息队列]""",

  """// 复杂嵌套：包和类的层次结构
#direction: down
#.package: fill=#e8f5e9 stroke=#2e7d32

[<package> com.example.domain|
  [<package> model|
    [User|id; name; email]
    [Order|id; userId; total]
  ]
  [<package> repository|
    [<interface> UserRepository]
    [<interface> OrderRepository]
  ]
  [<package> service|
    [UserService|repo: UserRepository|create(); find()]
    [OrderService|repo: OrderRepository|create(); list()]
  ]
]

// 跨包关系
[UserService] o-> [<interface> UserRepository]
[OrderService] o-> [<interface> OrderRepository]
[UserService] -> [User]
[OrderService] -> [Order]
[Order] -> [User]""",

  """// 表格和ID属性示例
#direction: down
#fontSize: 10

// 使用ID属性区分同名节点
[<id:user1> User|name: Alice]
[<id:user2> User|name: Bob]
[<id:admin1> User|name: Admin|role: ADMIN]

[<id:user1> User] -> [Project A]
[<id:user2> User] -> [Project B]
[<id:admin1> User] -> [Project A]
[<id:admin1> User] -> [Project B]

// 表格语法
[<table> 配置表|
环境 | 数据库 ||
开发 | localhost ||
生产 | prod.db.com]

[Project A] -> [<table> 配置表]"""
]
