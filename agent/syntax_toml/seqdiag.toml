[meta]
language = "seqdiag"
description = "简洁的时序图生成器,使用类 Python 语法快速绘制交互流程"
docs_url = "http://blockdiag.com/en/seqdiag/"
version = "1.0.0"

[types.diagram]
description = "时序图,展示系统组件之间的时间序列交互"
use_cases = [
  "系统交互流程",
  "API 调用序列",
  "微服务通信",
  "客户端服务器交互",
  "业务流程建模",
  "用户操作流程"
]

syntax_rules = """
核心语法:
- 声明: seqdiag { ... } 包裹全部内容
- 参与者: 自动推断,出现在箭头两侧即自动创建
- 预定义顺序: 可在开头声明参与者顺序,如 browser; server; database;
- 语句结尾: 每条消息必须用分号结尾

箭头类型:
- -> : 同步调用 (实线箭头)
- <-- : 同步返回 (实线返回箭头)
- ->> : 异步调用 (实线箭头,无返回)
- <<-- : 异步返回 (实线返回箭头)
- --> : 虚线调用
- <-- : 虚线返回
- => : 自动返回箭头 (会自动添加返回边)

消息语法:
- 基础消息: A -> B [label = "消息内容"];
- 自引用: A -> A [label = "自己调用自己"];
- 嵌套调用: A => B => C [label = "嵌套", return = "返回值"];
- 嵌套块: A => B [label = "调用"] { B -> C; B -> D; }

边属性:
- label: "消息文本" (必须使用双引号)
- diagonal: 对角线箭头
- color: 箭头颜色 (如 red, blue, #FF0000)
- failed: 失败标记 (显示为红色虚线)
- return: "返回值" (仅用于 => 箭头)

注释语法:
- note: "右侧注释" (默认在右侧)
- leftnote: "左侧注释"
- rightnote: "右侧注释"
- 示例: A -> B [label = "消息", note = "这是注释"];

分隔符:
- === 标题 ===  实线分隔符
- ... 标题 ...  虚线分隔符 (表示延迟)
- 用于分割不同阶段或步骤

自动返回 (=>):
- 使用 => 箭头会自动添加返回边
- 语法: A => B [label = "调用", return = "返回值"];
- return 属性指定返回消息的标签
- 嵌套自动返回: A => B => C [label = "调用", return = "返回"];

嵌套序列:
- 语法: A => B [label = "调用"] { B -> C; B -> D; }
- 大括号内为嵌套的子序列
- 必须使用 => 箭头
- 大括号必须闭合

图表属性 (放在 seqdiag { 后,消息前):
- edge_length: 水平间距 (默认 192)
- span_height: 垂直间距 (默认 40)
- default_fontsize: 字体大小 (默认 11)
- activation: none (隐藏激活线)
- autonumber: True (自动编号消息)
- default_note_color: 注释背景色 (如 lightblue, #FFE0B2)

参与者顺序控制:
- 在消息前声明参与者: client; api; cache; database;
- seqdiag 按首次出现的顺序从左到右排列
- 预先声明可以控制显示顺序

Kroki 限制:
- ✓ 完全支持所有箭头类型和属性
- ✓ 支持嵌套调用和自动返回
- ✓ 支持分隔符和注释
- ✓ 支持多语言文本 (UTF-8)
- ⚠️ 参与者数量建议 ≤ 10 个
- ⚠️ 嵌套层级建议 ≤ 3 层
- ⚠️ 消息数量建议 ≤ 50 条

常见错误:
- 标签引号错误
  * ❌ A -> B [label = 消息]
  * ✓ A -> B [label = "消息"];

- 缺少分号
  * ❌ A -> B [label = "消息"]
  * ✓ A -> B [label = "消息"];

- 嵌套块未闭合
  * ❌ A => B [label = "调用"] { B -> C;
  * ✓ A => B [label = "调用"] { B -> C; }

- 自动返回箭头错误
  * ❌ A -> B [return = "返回"]
  * ✓ A => B [return = "返回"];

- 属性名拼写错误
  * ❌ A -> B [lable = "消息"];
  * ✓ A -> B [label = "消息"];

实用技巧:
- 使用 autonumber = True 自动编号
- 使用 === 分隔符划分阶段
- 使用 failed 属性标记错误流程
- 使用 => 简化带返回的调用
- 使用 color 突出重要消息
- 使用 note 添加说明
"""

examples = [
  """
seqdiag {
  browser -> webserver [label = "GET /index.html"];
  browser <-- webserver;
  browser -> webserver [label = "POST /blog/comment"];
  webserver -> database [label = "INSERT comment"];
  webserver <-- database;
  browser <-- webserver;
}
  """,
  """
seqdiag {
  // 自动编号和彩色标注
  autonumber = True;
  default_note_color = lightblue;

  // 预定义参与者顺序
  client; api; cache; database;

  client => api [label = "登录请求"];
  api -> cache [label = "检查 Token"];
  cache --> api [label = "未找到", color = orange];

  === 数据库验证 ===

  api => database [label = "验证凭据", return = "用户数据"];
  api -> cache [label = "存储 Token"];
  api => client [label = "返回 Token", note = "有效期 24h"];
}
  """,
  """
seqdiag {
  // 嵌套调用和错误处理
  edge_length = 250;
  span_height = 60;

  user -> frontend [label = "提交订单"];
  frontend => backend [label = "创建订单"] {
    backend -> inventory [label = "检查库存"];
    inventory --> backend [failed, label = "库存不足"];
  }
  backend --> frontend [label = "订单失败", color = red];
  frontend --> user [rightnote = "显示错误提示"];
}
  """,
  """
seqdiag {
  // 完整的支付流程示例
  autonumber = True;
  edge_length = 300;
  default_fontsize = 13;

  // 定义参与者顺序
  用户; 商城; 支付网关; 银行; 商家;

  用户 -> 商城 [label = "选择商品"];
  商城 -> 用户 [label = "确认订单"];

  === 支付流程 ===

  用户 => 商城 [label = "发起支付"];
  商城 => 支付网关 [label = "创建支付订单", return = "订单号"];

  支付网关 -> 用户 [label = "跳转支付页面"];
  用户 => 支付网关 [label = "输入支付信息"];

  支付网关 => 银行 [label = "验证并扣款", return = "交易成功"];
  支付网关 -> 商城 [label = "支付成功通知"];

  ... 异步结算 ...

  支付网关 -> 商家 [label = "转账", note = "T+1 到账"];
  商城 -> 用户 [label = "发货", color = green];
}
  """,
  """
seqdiag {
  // 带注释的 API 调用流程
  default_note_color = "#FFF9C4";
  span_height = 50;

  // 边的类型演示
  App -> API [label = "同步调用"];
  App <-- API;

  App --> API [label = "虚线调用"];
  App <-- API;

  App ->> API [label = "异步调用", note = "不等待返回"];

  App -> API [diagonal, label = "对角线箭头"];

  App -> API [label = "失败请求", failed];
  App <- API [label = "返回错误", color = red];

  App -> App [label = "本地处理", leftnote = "自引用"];
}
  """
]
