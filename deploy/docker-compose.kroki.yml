services:
  # ============================================
  # DiagFlow 应用
  # ============================================
  app:
    image: ghcr.io/chyax98/diagflow:latest
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      # AI 提供商选择
      - AI_PROVIDER=${AI_PROVIDER:-openai}
      # OpenAI 兼容 API
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.moonshot.cn/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-kimi-k2-thinking}
      # Anthropic Claude API
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-https://api.anthropic.com}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-sonnet-4-20250514}
      # AI 推理配置
      - DIAGFLOW_MAX_STEPS=${DIAGFLOW_MAX_STEPS:-15}
      - DIAGFLOW_MAX_RETRIES=${DIAGFLOW_MAX_RETRIES:-3}
      # 使用本地 Kroki 服务（服务端运行时变量，通过 API 代理访问）
      - KROKI_BASE_URL=http://kroki:8000
      # Langfuse 监控（可选）
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-https://cloud.langfuse.com}
    depends_on:
      kroki:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Kroki 核心服务（网关）
  # ============================================
  kroki:
    image: yuzutech/kroki
    ports:
      - "${KROKI_PORT:-8000}:8000"
    environment:
      - KROKI_MERMAID_HOST=mermaid
      - KROKI_SAFE_MODE=unsafe
    depends_on:
      - mermaid
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # Mermaid 渲染服务
  # ============================================
  mermaid:
    image: yuzutech/kroki-mermaid
    expose:
      - "8002"
    restart: unless-stopped
