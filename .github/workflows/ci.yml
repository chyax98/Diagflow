name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  # ============================================
  # 前端检查和构建
  # ============================================
  frontend:
    name: 前端检查
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v6

      - name: 安装 pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: 设置 Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: 类型检查
        run: pnpm exec tsc --noEmit

      - name: 代码检查
        run: pnpm lint

      - name: 构建
        run: pnpm build
        env:
          AGENT_URL: http://localhost:8000
          NEXT_PUBLIC_KROKI_BASE_URL: https://kroki.io

  # ============================================
  # 后端检查
  # ============================================
  backend:
    name: 后端检查
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v6

      - name: 安装 uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "agent/uv.lock"

      - name: 设置 Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: 安装依赖
        working-directory: ./agent
        run: uv sync

      - name: Python 语法检查
        working-directory: ./agent
        run: uv run python -m py_compile src/*.py

      - name: 检查导入
        working-directory: ./agent
        run: |
          uv run python -c "from src.agent import agent"
          uv run python -c "from src.kroki_client import render_diagram"

  # ============================================
  # Docker 构建测试
  # ============================================
  docker:
    name: Docker 构建测试
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v6

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 构建前端镜像
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: diagflow-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: 构建后端镜像
        uses: docker/build-push-action@v6
        with:
          context: ./agent
          file: ./agent/Dockerfile
          push: false
          tags: diagflow-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # 整体状态检查（必需通过所有测试）
  # ============================================
  ci-success:
    name: CI 通过
    runs-on: ubuntu-latest
    needs: [frontend, backend, docker]
    if: always()

    steps:
      - name: 检查所有任务状态
        run: |
          if [[ "${{ needs.frontend.result }}" != "success" ]] || \
             [[ "${{ needs.backend.result }}" != "success" ]] || \
             [[ "${{ needs.docker.result }}" != "success" ]]; then
            echo "❌ CI 失败"
            exit 1
          fi
          echo "✅ 所有检查通过"
